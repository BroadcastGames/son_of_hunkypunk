# son_of_hunkypunk

Fork experimental development of Son of HunkyPunk, see the original project https://github.com/retrobits/son_of_hunkypunk

So far, major changes beyond app version 0.9.0:

 1. Android Studio 2.2.2, SDK 24 and related Gradle updates.
    Using NDK 12b, as NDK 13 requires rework of Android.mk makefiles and defaults to CLANG. Matter of getting right CLANG compile options or using NDK option to specify GCC.
 2. Git Interpreter upgraded from version 1.2.8 to version 1.3.4 with crash fixed due to long to jlong corruption.
 3. Some Git crashes are now trapped. It is still incomplete but less likely to hard-crash the entire app.
 4. RecyclerView GameListActivity now available. It is not very pretty and needs visual work, but it is a clean implementation and works with the established backend database.
 5. Common code to the old GamesList and new GameListActivity moved to common class outside the Activity.
 6. Multiple file paths are scanned for games. User Interface work not done on pick this yet, only hard coded paths.
 7. Unicode logic from Twisty app 2.0 (unreleased) has been hacked in and now Unicode output works much better in both Z-machine and Glulx story files generated by Inform 7 release 6M62!
 8. Greenrobot EventBus is introduced and background threads can operate more freely when the user rotates the screen or switches to another app.
 9. Gradle is used to control the applicationId and version of the build to allow multiple installs on the same device to compare new and old releases.
10. A sample game is now provided in the app assets and a setting decides if it is automatically installed on first run. It is a pure Public Domain story and can be distributed with zero copyright concern. This also paves the way for 'dedicated apps' that use SOHP as a distribution platform for their single story.

Side effects of the upgrade:

1. App Icon no longer apperas on the Title / Action Bar. SDK 21 and newer convention change. Reference: http://stackoverflow.com/questions/26720759/no-app-icon-on-actionbar
2. Colors on app first install are no longer dark and is a bright color set.
3. RecyclerView doesn't have the swipe navigation implemented.

We could implement these as 'build options' and possibly even a second 'build option' to present the user with preferences.

Kind of a vague concern: Google Play may not put the app in promos and 'featured apps' if it doesn't conform to modern style standards.

General observations:

1. in-game status bar/window font is often small. Were the score and other output goes for games.
2. The pre-set package of games to download disappears if any game is found. Maybe have a off the path way to redo this manually for user?
3. Picking the file path is clumsy on first startup. The app encourages you to install games immediately without setting the path and can orphan some downloads on path change.
4. Default to non SD-Card storage should probably increase compatibility of devices.
5. Some hard-coded testing game paths were added /sdcard/storyGames0 and /sdcard/storyGames1 to speed up testing of Git Interpreter / Glk changes.
6. Network activity related to looking up game details & graphics should probably be a preference option.

ToDo:

1. Shift JNI loading to static object as recommended here https://developer.android.com/training/articles/perf-jni.html
  That way the interfaces aren't redone every time activity pause/resumed when user switches away from app?
2. Much better behavior with JNI crashes so that Android app keeps control. Reference: http://blog.httrack.com/blog/2013/08/23/catching-posix-signals-on-android/  
3. Simulate caps-lock on the Android input side, have a menu checkbox to enable. CAVERNS.Z5 game for example.
4. If a single keystroke wait, remove the Shortcut list from the screen? A lot of stories have "press any key" prompts and a smarter use of shortcuts for this.
4a. On yes/no prompts such as quit, can we detect these and present a specific set of Shortcut buttons?
5. Move Night Mode higher in preferences as most likely to be popular option. Also make it a checkbox on Menu?
6. On Tablet emulator of Android 7.1.1, rotation results in focus los on input line with hard keyboard. And sometimes input below screen, manual pushing to scroll up required.
7. Rotate does not redraw story output for centering. For example, the opening banner of beneath.z5 - render in landscape, rotate to portrait, and the Z-machine logic will not be centered.  Probably WONTFIX, but at minimum document it in release notes.
8. Switch away from app during story to track down and solve "RuntimeException: android.os.TransactionTooLargeException: data parcel size 25605664 bytes"
10. Starting stories that check screen size can have a race condition where they get incorrect screen size and you have to close and reopen the story. zracer.z5 for example. It fails about half the time on the AVD emulator on a slow system.


To Investigate:

1. bear.z5 opening message "[Please press SPACE to begin.]" is split on two lines? Gargoyle does not do this.
2. Aug4.z8 opening message seems crammed on left 1/2 of the screen. Rotating to landscape reveals truncated message.
3. When using emulator with SDK 25 guest. Using the real keyboard with on-screen turned off. Typing the first letter stalls input focus. "q" "uit" requires click to put focus back. anchor.z8 is example game. NOTE: Turning off "Shortcuts List" in preferences seems to eliminate this problem. Focus gets puton the Shortcuts?
4. FIXED: animals.z5 or beneath.z5 opening banner monospace font, why is font so bad?
5. Tetris (freefall.z5) does not draw it's bottom line correctly?
6. Does the database backend (for RecyclerView List) overwrite identical games in the same path? What about two files with same name but different versions of code?
7. City of Secrets v3 exits on 'about' command?
8. ats.z8 "A Tight Spot" glitches on opening?
9. Search code for "todo -- transcript is broken" - is this on a ToDo list and in user docs?


Android 5.0 Blu Energy Studio 64-bit device failures

$ adb shell
$ run-as org.andglkmod.hunkypunk.dev
$ ls- l

Testing on x86_64 Tablet, Android 5.1 X80 Pro, reveals odd behavior:

1. even though System.getProperty("os.arch") shows x86_64, it seems to only load 32bit x86. How do you really know which is loaded?
2. deleting the x86 but not x86_64 from jniLibs (and verify missing from apk zip) results in it shifting to arm7l for System.getProperty("os.arch"). Conclusion: os.arch is the selected runtime fallback, not the actual hardware capability.

For now, the solution seems to be to make sure jniLibs has no 64bit binaries until the the code for C <--> Java is properly 64-bit safe.  This forces the target device to run in 32-bit for the C code.
 
NOTE: Twisty seems to work fine with two interpreters on Android 64bit tested on Intel x64 tablet and Blu arm64, so the issue seems to be here in how SOHP passes pointers between C and Java.
